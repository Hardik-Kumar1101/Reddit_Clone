<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <title>Post Details</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,1,0"/>
  <link rel="stylesheet" th:href="@{/css/post.css}"/>
  <script>
        function toggleReplyForm(commentId) {
            var replyForm = document.getElementById("reply-comment-form-" + commentId);
            if (replyForm.style.display === "none" || replyForm.style.display === "") {
                replyForm.style.display = "block";
            } else {
                replyForm.style.display = "none";
            }
        }
    </script>
</head>
<body>
<div class="content">
  <div class="post-container">
    <div class="element">
      <div th:text="${post.user.username}"></div>
      <div th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd h:mma')}"></div>
    </div>
    <h3 th:text="${post.postName}"></h3>
    <div th:text="${post.subreddit.name}"></div>
    <div th:text="${post.url}"></div>
    <div th:text="${post.description}"></div>
    <div th:if="${post.media != null}">
      <div th:if="${post.media.contentType.startsWith('image/')}">
        <img height="250px" width="100%" th:src="@{${'/display?id=' + post.media.mediaId}}" alt="Image">
      </div>

      <div th:if="${post.media.contentType.startsWith('video/')}">
        <video width="100%" controls>
          <source th:src="@{${'/display?id=' + post.media.mediaId}}"
                  th:type="${post.media.contentType}">
          Your browser does not support the video tag.
        </video>
      </div>
    </div>
    <div class="vote">
      <form th:if="${voteType == null || voteType == 'DOWNVOTE'}"
            th:action="@{/posts/upvote/{postId}/UPVOTE(postId=${post.postId})}" method="Get">
        <button type="submit">
          <span class="material-symbols-outlined">arrow_upward</span>
        </button>
      </form>
      <span th:text="${post.voteCount}"></span>
      <form th:if="${voteType == null || voteType == 'UPVOTE'}"
            th:action="@{/posts/downvote/{postId}/DOWNVOTE(postId=${post.postId})}" method="Get">
        <button type="submit">
          <span class="material-symbols-outlined">arrow_downward</span>
        </button>
      </form>
    </div>
  </div>
  <form action="#" th:action="@{'/addComment/'+${post.postId}}" method="post" class="comment-form">
    <textarea id="comment" name="content" placeholder="Reply" cols="40" rows="5" style="resize: none;
                                            width: 100%; height: 100px; font-size: 16px;" required></textarea>
    <button type="submit">Submit Comment</button>
  </form>

  <ol style="list-style-type: none;">
    <li th:each="comment : ${post.comments}" th:if="${comment.parentComment == null}" class="comment">
      <strong th:text="${comment.user.username}"></strong> &nbsp; &nbsp;
      <span th:text="'Created At ' + ${#temporals.format(comment.createdAt, 'dd/MM/yyyy, hh:mm a')}"></span>
      <div th:text="${comment.content}"></div> &nbsp; &nbsp;
      <div class="vote">
        <form th:action="@{/comments/upvote/{commentId}/UPVOTE(commentId=${comment.commentId})}" method="Get">
          <button type="submit">
            <span class="material-symbols-outlined">arrow_upward</span>
          </button>
        </form>
        <span th:text="${comment.voteCount}"></span>
        <form
                th:action="@{/comments/downvote/{commentId}/DOWNVOTE(commentId=${comment.commentId})}" method="Get">
          <button type="submit">
            <span class="material-symbols-outlined">arrow_downward</span>
          </button>
        </form>
      </div>
      <div sec:authorize="isAuthenticated()" class="edit-delete-button">
          <span th:if="${#authentication.principal.username == comment.user.email or #authentication.principal.username == post.user.email}">
            <span><a th:href="@{'/editComment/' + ${comment.commentId}}">Edit</a></span>
            <span><a th:href="@{'/deleteComment/' + ${comment.commentId}}">Delete</a></span>
          </span>
      </div>

      <div class="replies">
        <div th:if="${comment.replies.size() > 0}" >
          <a th:href="@{'/viewReplies/' + ${comment.commentId}}" class="comment-icon">
            <span class="material-symbols-outlined">
                 comment
            </span>
            <span th:text="${comment.replies.size()}"></span>
          </a>
        </div>
        <div th:unless="${comment.replies.size() > 0}" class="comment-icon">
          <div>
             <span class="material-symbols-outlined">
                 comment
            </span>
          </div>
          <div th:text="${comment.replies.size()}"></div>
        </div>
        <span><a th:attr="onclick='toggleReplyForm(\'' + ${comment.commentId} + '\')'">Reply</a></span>
      </div>
      <div th:id="'reply-comment-form-' + ${comment.commentId}" style="display: none;">
        <form th:action="@{'/replyOnComment/' + ${comment.commentId}}" method="post">
          <label for="new-comment-text">Comment</label>
          <textarea id="new-comment-text" name="content" th:value="${content}" ></textarea>
          <button type="submit">Save</button>
        </form>
      </div>
    </li>
  </ol>

  <div sec:authorize="isAuthenticated()">
    <div th:if="${#authentication.principal.username == post.user.email}" class="post-edit-delete-button">
      <form th:action="@{'/update-post/' + ${post.postId}}" method="POST">
        <input type="submit" value="Edit">
      </form>
      <form th:action="@{'/delete-post/' + ${post.postId}}" method="POST">
        <input type="submit" value="Delete">
      </form>
    </div>
  </div>
</div>
</body>
</html>